<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üå≥ Erdtree Dynamic AVM Portal</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://alcdn.msauth.net/browser/2.38.3/js/msal-browser.min.js"></script>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; }
        .resource-card { transition: all 0.3s ease; }
        .resource-card:hover { transform: translateY(-2px); box-shadow: 0 8px 25px rgba(0,0,0,0.15); }
        .loading-spinner { animation: spin 1s linear infinite; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        .line-clamp-2 { display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
        .category-blue { @apply bg-blue-50 border-blue-200 hover:bg-blue-100 hover:border-blue-300; }
        .category-green { @apply bg-green-50 border-green-200 hover:bg-green-100 hover:border-green-300; }
        .category-yellow { @apply bg-yellow-50 border-yellow-200 hover:bg-yellow-100 hover:border-yellow-300; }
        .category-purple { @apply bg-purple-50 border-purple-200 hover:bg-purple-100 hover:border-purple-300; }
        .category-red { @apply bg-red-50 border-red-200 hover:bg-red-100 hover:border-red-300; }
        .category-gray { @apply bg-gray-50 border-gray-200 hover:bg-gray-100 hover:border-gray-300; }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <div id="root">
        <div class="min-h-screen flex items-center justify-center">
            <div class="text-center">
                <div class="loading-spinner rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto mb-4"></div>
                <p class="text-gray-600">Initializing Dynamic AVM Portal...</p>
            </div>
        </div>
    </div>
    
    <script>
        // MSAL Configuration
        const msalConfig = {
            auth: {
                clientId: 'bddf94ca-ff1f-4cc9-aac9-4fd51d3af064',
                authority: 'https://login.microsoftonline.com/b6458a9a-9661-468c-bda3-5f496727d0b0',
                redirectUri: window.location.origin,
            },
            cache: {
                cacheLocation: 'sessionStorage',
                storeAuthStateInCookie: false,
            }
        };

        // Global state
        let msalInstance;
        let currentUser = null;
        let isLoading = true;
        let schemas = [];
        let filteredSchemas = [];
        let selectedSchema = null;
        let showDeploymentForm = false;
        let searchQuery = '';
        let selectedCategories = [];
        let viewMode = 'grid';
        let showFeaturedOnly = false;
        let sortBy = 'downloads';
        let sortOrder = 'desc';
        
        // Categories with metadata
        const CATEGORIES = {
            compute: { name: 'compute', displayName: 'Compute', icon: 'üñ•Ô∏è', color: 'blue' },
            network: { name: 'network', displayName: 'Networking', icon: 'üåê', color: 'green' },
            storage: { name: 'storage', displayName: 'Storage', icon: 'üíæ', color: 'yellow' },
            database: { name: 'database', displayName: 'Database', icon: 'üóÑÔ∏è', color: 'purple' },
            security: { name: 'security', displayName: 'Security', icon: 'üîí', color: 'red' },
            monitoring: { name: 'monitoring', displayName: 'Monitoring', icon: 'üìä', color: 'indigo' },
            integration: { name: 'integration', displayName: 'Integration', icon: 'üîó', color: 'pink' },
            web: { name: 'web', displayName: 'Web', icon: 'üåç', color: 'teal' },
            ai: { name: 'ai', displayName: 'AI & ML', icon: 'ü§ñ', color: 'orange' },
            other: { name: 'other', displayName: 'Other', icon: 'üì¶', color: 'gray' }
        };

        // Mock AVM schemas (in production, this would come from the API)
        const mockSchemas = [
            {
                moduleId: 'Azure-avm-res-compute-virtualmachine-azurerm',
                name: 'Virtual Machine',
                namespace: 'Azure',
                provider: 'azurerm',
                version: '1.2.0',
                description: 'Deploy Windows or Linux virtual machines with advanced configuration options',
                category: 'compute',
                icon: 'üñ•Ô∏è',
                featured: true,
                lastUpdated: '2024-12-15T10:30:00Z',
                downloads: 15420,
                variables: [
                    { name: 'name', type: 'string', description: 'The name of the virtual machine', required: true },
                    { name: 'location', type: 'string', description: 'Azure region for deployment', required: true, default: 'East US' },
                    { name: 'resource_group_name', type: 'string', description: 'Resource group name', required: true },
                    { name: 'vm_size', type: 'string', description: 'VM size/SKU', required: true, default: 'Standard_B2s' },
                    { name: 'admin_username', type: 'string', description: 'Administrator username', required: true },
                    { name: 'admin_password', type: 'string', description: 'Administrator password', required: false, sensitive: true },
                    { name: 'os_type', type: 'string', description: 'Operating system type', required: true, default: 'Linux' }
                ],
                metadata: {
                    maturity: 'stable',
                    tags: ['compute', 'vm', 'featured'],
                    sourceUrl: 'https://github.com/Azure/terraform-azurerm-avm-res-compute-virtualmachine'
                }
            },
            {
                moduleId: 'Azure-avm-res-storage-storageaccount-azurerm',
                name: 'Storage Account',
                namespace: 'Azure',
                provider: 'azurerm',
                version: '1.1.0',
                description: 'Create Azure Storage Accounts with blob, file, queue, and table services',
                category: 'storage',
                icon: 'üíæ',
                featured: true,
                lastUpdated: '2024-12-14T15:45:00Z',
                downloads: 12350,
                variables: [
                    { name: 'name', type: 'string', description: 'Storage account name', required: true },
                    { name: 'location', type: 'string', description: 'Azure region', required: true, default: 'East US' },
                    { name: 'resource_group_name', type: 'string', description: 'Resource group name', required: true },
                    { name: 'account_tier', type: 'string', description: 'Storage account tier', required: false, default: 'Standard' },
                    { name: 'account_replication_type', type: 'string', description: 'Replication type', required: false, default: 'LRS' }
                ],
                metadata: {
                    maturity: 'stable',
                    tags: ['storage', 'blob', 'featured'],
                    sourceUrl: 'https://github.com/Azure/terraform-azurerm-avm-res-storage-storageaccount'
                }
            },
            {
                moduleId: 'Azure-avm-res-network-virtualnetwork-azurerm',
                name: 'Virtual Network',
                namespace: 'Azure',
                provider: 'azurerm',
                version: '1.0.3',
                description: 'Deploy Azure Virtual Networks with subnets and network security groups',
                category: 'network',
                icon: 'üåê',
                featured: true,
                lastUpdated: '2024-12-13T09:20:00Z',
                downloads: 9870,
                variables: [
                    { name: 'name', type: 'string', description: 'Virtual network name', required: true },
                    { name: 'location', type: 'string', description: 'Azure region', required: true, default: 'East US' },
                    { name: 'resource_group_name', type: 'string', description: 'Resource group name', required: true },
                    { name: 'address_space', type: 'list(string)', description: 'Address space for VNet', required: true, default: ['10.0.0.0/16'] },
                    { name: 'subnets', type: 'map(object)', description: 'Subnet configuration', required: false }
                ],
                metadata: {
                    maturity: 'stable',
                    tags: ['network', 'vnet', 'featured'],
                    sourceUrl: 'https://github.com/Azure/terraform-azurerm-avm-res-network-virtualnetwork'
                }
            },
            {
                moduleId: 'Azure-avm-res-web-site-azurerm',
                name: 'App Service',
                namespace: 'Azure',
                provider: 'azurerm',
                version: '0.9.2',
                description: 'Deploy Azure App Service for web applications and APIs',
                category: 'web',
                icon: 'üåç',
                featured: false,
                lastUpdated: '2024-12-12T14:10:00Z',
                downloads: 7650,
                variables: [
                    { name: 'name', type: 'string', description: 'App Service name', required: true },
                    { name: 'location', type: 'string', description: 'Azure region', required: true, default: 'East US' },
                    { name: 'resource_group_name', type: 'string', description: 'Resource group name', required: true },
                    { name: 'service_plan_id', type: 'string', description: 'App Service Plan ID', required: true },
                    { name: 'runtime_stack', type: 'string', description: 'Application runtime', required: false, default: 'node' }
                ],
                metadata: {
                    maturity: 'preview',
                    tags: ['web', 'app-service'],
                    sourceUrl: 'https://github.com/Azure/terraform-azurerm-avm-res-web-site'
                }
            },
            {
                moduleId: 'Azure-avm-res-keyvault-vault-azurerm',
                name: 'Key Vault',
                namespace: 'Azure',
                provider: 'azurerm',
                version: '1.1.1',
                description: 'Create Azure Key Vault for secrets, keys, and certificates management',
                category: 'security',
                icon: 'üîí',
                featured: false,
                lastUpdated: '2024-12-11T11:55:00Z',
                downloads: 6420,
                variables: [
                    { name: 'name', type: 'string', description: 'Key Vault name', required: true },
                    { name: 'location', type: 'string', description: 'Azure region', required: true, default: 'East US' },
                    { name: 'resource_group_name', type: 'string', description: 'Resource group name', required: true },
                    { name: 'sku_name', type: 'string', description: 'Key Vault SKU', required: false, default: 'standard' },
                    { name: 'tenant_id', type: 'string', description: 'Azure AD tenant ID', required: true }
                ],
                metadata: {
                    maturity: 'stable',
                    tags: ['security', 'keyvault'],
                    sourceUrl: 'https://github.com/Azure/terraform-azurerm-avm-res-keyvault-vault'
                }
            },
            {
                moduleId: 'Azure-avm-res-containerinstance-containergroup-azurerm',
                name: 'Container Instances',
                namespace: 'Azure',
                provider: 'azurerm',
                version: '0.8.1',
                description: 'Deploy Azure Container Instances for containerized applications',
                category: 'compute',
                icon: 'üì¶',
                featured: false,
                lastUpdated: '2024-12-10T16:30:00Z',
                downloads: 3210,
                variables: [
                    { name: 'name', type: 'string', description: 'Container group name', required: true },
                    { name: 'location', type: 'string', description: 'Azure region', required: true, default: 'East US' },
                    { name: 'resource_group_name', type: 'string', description: 'Resource group name', required: true },
                    { name: 'containers', type: 'list(object)', description: 'Container configurations', required: true },
                    { name: 'os_type', type: 'string', description: 'Operating system type', required: false, default: 'Linux' }
                ],
                metadata: {
                    maturity: 'preview',
                    tags: ['compute', 'container'],
                    sourceUrl: 'https://github.com/Azure/terraform-azurerm-avm-res-containerinstance-containergroup'
                }
            }
        ];

        // Initialize authentication
        async function initializeAuth() {
            try {
                msalInstance = new msal.PublicClientApplication(msalConfig);
                await msalInstance.initialize();
                
                const accounts = msalInstance.getAllAccounts();
                if (accounts.length > 0) {
                    currentUser = accounts[0];
                }
                
                isLoading = false;
                render();
            } catch (error) {
                console.error('Auth initialization failed:', error);
                isLoading = false;
                render();
            }
        }

        // Login function
        async function handleLogin() {
            try {
                isLoading = true;
                render();
                
                const response = await msalInstance.loginPopup({
                    scopes: ['User.Read', 'https://management.azure.com/user_impersonation']
                });
                
                currentUser = response.account;
                isLoading = false;
                loadSchemas();
                render();
            } catch (error) {
                console.error('Login failed:', error);
                isLoading = false;
                render();
            }
        }

        // Logout function
        async function handleLogout() {
            try {
                await msalInstance.logoutPopup();
                currentUser = null;
                render();
            } catch (error) {
                console.error('Logout failed:', error);
                currentUser = null;
                render();
            }
        }

        // Load schemas (mock data for demo)
        async function loadSchemas() {
            try {
                // In production, this would be: await fetch('/api/schemas')
                await new Promise(resolve => setTimeout(resolve, 1000)); // Simulate API call
                schemas = mockSchemas;
                applyFilters();
            } catch (error) {
                console.error('Failed to load schemas:', error);
                schemas = [];
            }
        }

        // Apply filters to schemas
        function applyFilters() {
            let filtered = [...schemas];

            // Apply search filter
            if (searchQuery) {
                const query = searchQuery.toLowerCase();
                filtered = filtered.filter(schema =>
                    schema.name.toLowerCase().includes(query) ||
                    schema.description.toLowerCase().includes(query) ||
                    schema.metadata.tags.some(tag => tag.toLowerCase().includes(query))
                );
            }

            // Apply category filter
            if (selectedCategories.length > 0) {
                filtered = filtered.filter(schema => selectedCategories.includes(schema.category));
            }

            // Apply featured filter
            if (showFeaturedOnly) {
                filtered = filtered.filter(schema => schema.featured);
            }

            // Apply sorting
            filtered.sort((a, b) => {
                let aValue, bValue;

                switch (sortBy) {
                    case 'name':
                        aValue = a.name.toLowerCase();
                        bValue = b.name.toLowerCase();
                        break;
                    case 'downloads':
                        aValue = a.downloads;
                        bValue = b.downloads;
                        break;
                    case 'updated':
                        aValue = new Date(a.lastUpdated);
                        bValue = new Date(b.lastUpdated);
                        break;
                    default:
                        return 0;
                }

                if (typeof aValue === 'string') {
                    return sortOrder === 'desc' 
                        ? bValue.localeCompare(aValue)
                        : aValue.localeCompare(bValue);
                }

                return sortOrder === 'desc' ? bValue - aValue : aValue - bValue;
            });

            filteredSchemas = filtered;
            render();
        }

        // Handle search
        function handleSearch(query) {
            searchQuery = query;
            applyFilters();
        }

        // Toggle category filter
        function toggleCategory(category) {
            if (selectedCategories.includes(category)) {
                selectedCategories = selectedCategories.filter(c => c !== category);
            } else {
                selectedCategories.push(category);
            }
            applyFilters();
        }

        // Handle module selection
        function selectModule(schema) {
            selectedSchema = schema;
            showDeploymentForm = true;
            render();
        }

        // Handle deployment submission
        async function submitDeployment(formData) {
            try {
                const deploymentRequest = {
                    deploymentId: `erdtree-${Date.now()}`,
                    moduleId: selectedSchema.moduleId,
                    moduleName: selectedSchema.name,
                    moduleVersion: selectedSchema.version,
                    requestedBy: currentUser?.username || currentUser?.name,
                    variables: formData,
                    timestamp: new Date().toISOString()
                };

                // Simulate API call to Logic App
                await new Promise(resolve => setTimeout(resolve, 2000));

                alert(`‚úÖ Deployment Request Submitted!\n\n` +
                      `Module: ${selectedSchema.name} v${selectedSchema.version}\n` +
                      `Deployment ID: ${deploymentRequest.deploymentId}\n` +
                      `Requested by: ${currentUser.username || currentUser.name}\n\n` +
                      `Approval email sent to: hemirafl@microsoft.com\n\n` +
                      `You will be notified once the request is processed.`);

                showDeploymentForm = false;
                selectedSchema = null;
                render();
            } catch (error) {
                console.error('Deployment submission failed:', error);
                alert('Failed to submit deployment request. Please try again.');
            }
        }

        // Render module card
        function renderModuleCard(schema) {
            const categoryInfo = CATEGORIES[schema.category] || CATEGORIES.other;
            const maturityColor = schema.metadata.maturity === 'stable' ? 'green' : 
                                 schema.metadata.maturity === 'preview' ? 'orange' : 'red';

            return `
                <div onclick="selectModule(${JSON.stringify(schema).replace(/"/g, '&quot;')})"
                     class="resource-card p-6 rounded-xl border-2 cursor-pointer category-${categoryInfo.color} relative">
                    
                    ${schema.featured ? `
                        <div class="absolute top-2 right-2 bg-yellow-400 text-yellow-900 px-2 py-1 rounded-full text-xs font-semibold">
                            ‚≠ê Featured
                        </div>
                    ` : ''}
                    
                    <div class="absolute top-2 left-2 px-2 py-1 rounded-full text-xs font-medium
                         ${maturityColor === 'green' ? 'bg-green-100 text-green-800' : ''}
                         ${maturityColor === 'orange' ? 'bg-orange-100 text-orange-800' : ''}
                         ${maturityColor === 'red' ? 'bg-red-100 text-red-800' : ''}">
                        ${schema.metadata.maturity === 'stable' ? '‚úÖ' : schema.metadata.maturity === 'preview' ? 'üî∂' : 'üß™'}
                        ${schema.metadata.maturity}
                    </div>
                    
                    <div class="mt-8">
                        <div class="flex items-start space-x-4 mb-4">
                            <div class="text-4xl">${schema.icon}</div>
                            <div class="flex-1">
                                <h3 class="text-xl font-semibold text-gray-900 mb-2">
                                    ${schema.name}
                                </h3>
                                <p class="text-sm text-gray-600 line-clamp-2 mb-3">
                                    ${schema.description}
                                </p>
                            </div>
                        </div>
                        
                        <div class="flex items-center justify-between text-xs text-gray-500 mb-3">
                            <span class="inline-block px-2 py-1 bg-white rounded-full font-medium">
                                ${categoryInfo.displayName}
                            </span>
                            <div class="flex items-center space-x-2">
                                <span>üì• ${schema.downloads.toLocaleString()}</span>
                                <span>v${schema.version}</span>
                            </div>
                        </div>
                        
                        <div class="flex flex-wrap gap-1">
                            ${schema.metadata.tags.slice(0, 3).map(tag => `
                                <span class="px-2 py-1 bg-white text-gray-600 rounded text-xs">${tag}</span>
                            `).join('')}
                            ${schema.metadata.tags.length > 3 ? `
                                <span class="px-2 py-1 bg-white text-gray-400 rounded text-xs">
                                    +${schema.metadata.tags.length - 3}
                                </span>
                            ` : ''}
                        </div>
                    </div>
                </div>
            `;
        }

        // Render deployment form
        function renderDeploymentForm() {
            if (!selectedSchema) return '';

            return `
                <div class="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center z-50 p-4">
                    <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full max-h-[90vh] overflow-y-auto">
                        <div class="p-6 border-b border-gray-200">
                            <div class="flex items-center space-x-3">
                                <span class="text-3xl">${selectedSchema.icon}</span>
                                <div>
                                    <h2 class="text-xl font-semibold text-gray-900">
                                        Deploy ${selectedSchema.name}
                                    </h2>
                                    <p class="text-sm text-gray-600">
                                        Version ${selectedSchema.version} ‚Ä¢ ${selectedSchema.metadata.maturity}
                                    </p>
                                </div>
                            </div>
                            <p class="mt-2 text-gray-600">${selectedSchema.description}</p>
                        </div>
                        
                        <form onsubmit="handleFormSubmit(event)" class="p-6 space-y-4">
                            ${selectedSchema.variables.map(variable => `
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">
                                        ${variable.name.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase())}
                                        ${variable.required ? '<span class="text-red-500">*</span>' : ''}
                                        ${variable.sensitive ? '<span class="text-orange-500 ml-1">üîí</span>' : ''}
                                    </label>
                                    ${variable.description ? `
                                        <p class="text-sm text-gray-500 mb-2">${variable.description}</p>
                                    ` : ''}
                                    <input
                                        type="${variable.sensitive ? 'password' : variable.type === 'number' ? 'number' : 'text'}"
                                        name="${variable.name}"
                                        ${variable.required ? 'required' : ''}
                                        value="${variable.default || ''}"
                                        placeholder="Enter ${variable.name.replace(/_/g, ' ')}"
                                        class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                    />
                                </div>
                            `).join('')}
                            
                            <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                                <p class="text-sm text-blue-800">
                                    <strong>Deployment Process:</strong><br>
                                    1. Request will be sent for approval to hemirafl@microsoft.com<br>
                                    2. Upon approval, Terraform will deploy using Azure Verified Modules<br>
                                    3. You'll receive notifications at each step
                                </p>
                            </div>
                            
                            <div class="flex items-center justify-end space-x-3 pt-4 border-t border-gray-200">
                                <button
                                    type="button"
                                    onclick="showDeploymentForm = false; render()"
                                    class="px-4 py-2 border border-gray-300 rounded-md text-gray-700 hover:bg-gray-50"
                                >
                                    Cancel
                                </button>
                                <button
                                    type="submit"
                                    class="px-6 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700"
                                >
                                    Submit for Approval
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            `;
        }

        // Handle form submission
        function handleFormSubmit(event) {
            event.preventDefault();
            const formData = new FormData(event.target);
            const variables = {};
            
            for (const [key, value] of formData.entries()) {
                variables[key] = value;
            }
            
            submitDeployment(variables);
        }

        // Main render function
        function render() {
            const root = document.getElementById('root');

            if (isLoading) {
                root.innerHTML = `
                    <div class="min-h-screen flex items-center justify-center">
                        <div class="text-center">
                            <div class="loading-spinner rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto mb-4"></div>
                            <p class="text-gray-600">Initializing Dynamic AVM Portal...</p>
                        </div>
                    </div>
                `;
                return;
            }

            if (!currentUser) {
                root.innerHTML = `
                    <div class="min-h-screen flex items-center justify-center bg-gradient-to-br from-blue-50 to-indigo-100">
                        <div class="max-w-md w-full mx-4">
                            <div class="bg-white rounded-lg shadow-xl p-8 text-center">
                                <div class="text-6xl mb-6">üå≥</div>
                                <h1 class="text-3xl font-bold text-gray-900 mb-4">
                                    Erdtree Dynamic AVM Portal
                                </h1>
                                <p class="text-gray-600 mb-8">
                                    Auto-syncing Azure Verified Modules catalog with dynamic form generation and approval workflows.
                                </p>
                                <button
                                    onclick="handleLogin()"
                                    class="w-full bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700 font-semibold"
                                >
                                    üîê Sign in with Microsoft
                                </button>
                                <div class="mt-6 text-sm text-gray-500">
                                    <p>‚úÖ Real Azure AD authentication</p>
                                    <p>ü§ñ Auto-syncing module catalog</p>
                                    <p>üìù Dynamic form generation</p>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                return;
            }

            root.innerHTML = `
                <div class="min-h-screen bg-gray-50">
                    <!-- Header -->
                    <header class="bg-white shadow-sm border-b border-gray-200">
                        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                            <div class="flex justify-between items-center py-6">
                                <div class="flex items-center">
                                    <span class="text-3xl mr-3">üå≥</span>
                                    <div>
                                        <h1 class="text-2xl font-bold text-gray-900">
                                            Erdtree Dynamic AVM Portal
                                        </h1>
                                        <p class="text-sm text-gray-600">Auto-syncing Azure Verified Modules Catalog</p>
                                    </div>
                                </div>
                                <div class="flex items-center space-x-4">
                                    <div class="text-right">
                                        <p class="text-sm font-medium text-gray-900">
                                            ${currentUser.name || 'User'}
                                        </p>
                                        <p class="text-xs text-gray-500">
                                            ${currentUser.username || currentUser.homeAccountId || ''}
                                        </p>
                                    </div>
                                    <button
                                        onclick="handleLogout()"
                                        class="text-sm text-blue-600 hover:text-blue-800 font-medium"
                                    >
                                        Sign out
                                    </button>
                                </div>
                            </div>
                        </div>
                    </header>

                    <!-- Main Content -->
                    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
                        <!-- Search and Filters -->
                        <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6 mb-6">
                            <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between space-y-4 lg:space-y-0 mb-4">
                                <div class="flex-1 lg:max-w-lg">
                                    <div class="relative">
                                        <input
                                            type="text"
                                            placeholder="Search Azure Verified Modules..."
                                            value="${searchQuery}"
                                            oninput="handleSearch(this.value)"
                                            class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                                        />
                                        <svg class="absolute left-3 top-1/2 transform -translate-y-1/2 w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                                        </svg>
                                    </div>
                                </div>
                                <div class="flex items-center space-x-3">
                                    <span class="text-sm text-gray-600">${filteredSchemas.length} modules</span>
                                    <button
                                        onclick="loadSchemas(); render()"
                                        class="px-3 py-2 text-gray-600 hover:text-gray-800"
                                        title="Refresh catalog"
                                    >
                                        üîÑ
                                    </button>
                                </div>
                            </div>

                            <!-- Category Filters -->
                            <div class="space-y-3">
                                <h4 class="text-sm font-medium text-gray-900">Categories</h4>
                                <div class="flex flex-wrap gap-2">
                                    ${Object.entries(CATEGORIES).map(([key, category]) => `
                                        <button
                                            onclick="toggleCategory('${key}')"
                                            class="px-3 py-1 rounded-full text-sm font-medium transition-colors
                                                ${selectedCategories.includes(key)
                                                    ? 'bg-blue-100 text-blue-800 border border-blue-300'
                                                    : 'bg-gray-100 text-gray-700 hover:bg-gray-200'
                                                }"
                                        >
                                            ${category.icon} ${category.displayName}
                                        </button>
                                    `).join('')}
                                </div>
                                
                                <div class="flex items-center space-x-4">
                                    <label class="flex items-center">
                                        <input
                                            type="checkbox"
                                            ${showFeaturedOnly ? 'checked' : ''}
                                            onchange="showFeaturedOnly = this.checked; applyFilters()"
                                            class="h-4 w-4 text-blue-600 border-gray-300 rounded"
                                        />
                                        <span class="ml-2 text-sm text-gray-700">Featured only</span>
                                    </label>
                                    
                                    <select
                                        onchange="sortBy = this.value.split('-')[0]; sortOrder = this.value.split('-')[1]; applyFilters()"
                                        class="text-sm border border-gray-300 rounded px-2 py-1"
                                    >
                                        <option value="downloads-desc" ${sortBy === 'downloads' && sortOrder === 'desc' ? 'selected' : ''}>Most Popular</option>
                                        <option value="name-asc" ${sortBy === 'name' && sortOrder === 'asc' ? 'selected' : ''}>Name A-Z</option>
                                        <option value="updated-desc" ${sortBy === 'updated' && sortOrder === 'desc' ? 'selected' : ''}>Recently Updated</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <!-- Module Grid -->
                        ${filteredSchemas.length === 0 ? `
                            <div class="text-center py-12">
                                <div class="text-gray-400 text-6xl mb-4">üîç</div>
                                <h3 class="text-lg font-medium text-gray-900 mb-2">No modules found</h3>
                                <p class="text-gray-500">Try adjusting your search or filters</p>
                            </div>
                        ` : `
                            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                                ${filteredSchemas.map(renderModuleCard).join('')}
                            </div>
                        `}

                        <!-- System Status -->
                        <div class="mt-12 bg-blue-50 border border-blue-200 rounded-lg p-6">
                            <h3 class="text-xl font-semibold text-blue-900 mb-4">
                                ü§ñ Dynamic AVM System Status
                            </h3>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                                <div class="space-y-2">
                                    <div class="flex items-center">
                                        <span class="text-green-500 mr-2">‚úÖ</span>
                                        <span>Schema Sync: Automated daily at 2 AM UTC</span>
                                    </div>
                                    <div class="flex items-center">
                                        <span class="text-green-500 mr-2">‚úÖ</span>
                                        <span>Form Generation: Dynamic from Terraform variables</span>
                                    </div>
                                    <div class="flex items-center">
                                        <span class="text-green-500 mr-2">‚úÖ</span>
                                        <span>Authentication: Azure AD with real accounts</span>
                                    </div>
                                </div>
                                <div class="space-y-2">
                                    <div class="flex items-center">
                                        <span class="text-green-500 mr-2">‚úÖ</span>
                                        <span>Catalog: ${schemas.length} Azure Verified Modules loaded</span>
                                    </div>
                                    <div class="flex items-center">
                                        <span class="text-green-500 mr-2">‚úÖ</span>
                                        <span>Approval Workflow: Logic App integration ready</span>
                                    </div>
                                    <div class="flex items-center">
                                        <span class="text-blue-500 mr-2">üîó</span>
                                        <span>GitHub: terraform-avm-cicd-demo</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </main>
                </div>

                ${showDeploymentForm ? renderDeploymentForm() : ''}
            `;
        }

        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üå≥ Erdtree Dynamic AVM Portal - Starting...');
            initializeAuth().then(() => {
                if (currentUser) {
                    loadSchemas();
                }
            });
        });
    </script>
</body>
</html>