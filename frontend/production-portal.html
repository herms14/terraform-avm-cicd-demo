<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üå≥ Erdtree Self-Service Portal</title>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@azure/msal-browser@3.0.0/dist/msal-browser.min.js"></script>
    <script>
        // Configure Tailwind for proper CSS loading
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        azure: {
                            50: '#eff6ff',
                            500: '#3b82f6',
                            600: '#2563eb',
                            700: '#1d4ed8'
                        }
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-gray-50 min-h-screen">
    <div id="root"></div>
    
    <script type="text/babel">
        const { useState, useEffect } = React;
        
        // MSAL Configuration for Azure AD
        const msalConfig = {
            auth: {
                clientId: 'bddf94ca-ff1f-4cc9-aac9-4fd51d3af064',
                authority: 'https://login.microsoftonline.com/b6458a9a-9661-468c-bda3-5f496727d0b0',
                redirectUri: window.location.origin,
            },
            cache: {
                cacheLocation: 'sessionStorage',
                storeAuthStateInCookie: false,
            },
            system: {
                loggerOptions: {
                    loggerCallback: (level, message, containsPii) => {
                        if (containsPii) return;
                        console.log(message);
                    }
                }
            }
        };
        
        // Initialize MSAL instance
        let msalInstance;
        try {
            msalInstance = new msal.PublicClientApplication(msalConfig);
        } catch (error) {
            console.error('MSAL initialization failed:', error);
        }
        
        // Resource definitions
        const resources = [
            { 
                id: 'vm-windows', 
                name: 'Windows VM', 
                icon: 'üñ•Ô∏è', 
                desc: 'Deploy Windows Server virtual machines with IIS', 
                category: 'compute',
                color: 'blue'
            },
            { 
                id: 'vm-linux', 
                name: 'Linux VM', 
                icon: 'üêß', 
                desc: 'Deploy Ubuntu/RHEL virtual machines', 
                category: 'compute',
                color: 'blue'
            },
            { 
                id: 'storage', 
                name: 'Storage Account', 
                icon: 'üíæ', 
                desc: 'Create blob, file, and queue storage', 
                category: 'storage',
                color: 'yellow'
            },
            { 
                id: 'vnet', 
                name: 'Virtual Network', 
                icon: 'üåê', 
                desc: 'Create VNets with subnets and NSGs', 
                category: 'network',
                color: 'green'
            },
            { 
                id: 'webapp', 
                name: 'Web App', 
                icon: 'üåç', 
                desc: 'Host .NET/Node.js/Python applications', 
                category: 'web',
                color: 'purple'
            },
            { 
                id: 'loadbalancer', 
                name: 'Load Balancer', 
                icon: '‚öñÔ∏è', 
                desc: 'Distribute traffic with high availability', 
                category: 'network',
                color: 'green'
            }
        ];
        
        // Main App Component
        function ErdtreePortal() {
            const [user, setUser] = useState(null);
            const [loading, setLoading] = useState(true);
            const [selectedResource, setSelectedResource] = useState(null);
            const [showDeploymentForm, setShowDeploymentForm] = useState(false);
            const [deploymentData, setDeploymentData] = useState({
                environment: 'dev',
                subscription: 'Nokron-Prod',
                resourceName: '',
                location: 'West US 2'
            });
            
            // Initialize authentication
            useEffect(() => {
                const initializeAuth = async () => {
                    if (!msalInstance) {
                        setLoading(false);
                        return;
                    }
                    
                    try {
                        await msalInstance.initialize();
                        const accounts = msalInstance.getAllAccounts();
                        if (accounts.length > 0) {
                            setUser(accounts[0]);
                        }
                    } catch (error) {
                        console.error('Auth initialization failed:', error);
                    } finally {
                        setLoading(false);
                    }
                };
                
                initializeAuth();
            }, []);
            
            // Login function
            const handleLogin = async () => {
                if (!msalInstance) {
                    alert('Authentication not available. Please refresh the page.');
                    return;
                }
                
                try {
                    setLoading(true);
                    const response = await msalInstance.loginPopup({
                        scopes: ['User.Read', 'https://management.azure.com/.default']
                    });
                    setUser(response.account);
                } catch (error) {
                    console.error('Login failed:', error);
                    alert('Login failed. Please try again.');
                } finally {
                    setLoading(false);
                }
            };
            
            // Logout function
            const handleLogout = async () => {
                if (!msalInstance) return;
                
                try {
                    await msalInstance.logoutPopup();
                    setUser(null);
                } catch (error) {
                    console.error('Logout failed:', error);
                }
            };
            
            // Get category styling
            const getCategoryStyle = (color) => {
                const styles = {
                    blue: 'bg-blue-50 border-blue-200 hover:bg-blue-100 hover:border-blue-300',
                    green: 'bg-green-50 border-green-200 hover:bg-green-100 hover:border-green-300',
                    yellow: 'bg-yellow-50 border-yellow-200 hover:bg-yellow-100 hover:border-yellow-300',
                    purple: 'bg-purple-50 border-purple-200 hover:bg-purple-100 hover:border-purple-300'
                };
                return styles[color] || 'bg-gray-50 border-gray-200 hover:bg-gray-100';
            };
            
            // Handle resource selection
            const handleResourceSelect = (resource) => {
                setSelectedResource(resource);
                setDeploymentData(prev => ({
                    ...prev,
                    resourceName: `${resource.name.toLowerCase().replace(' ', '-')}-${Date.now()}`
                }));
                setShowDeploymentForm(true);
            };
            
            // Submit deployment request
            const handleDeploymentSubmit = async () => {
                const deploymentRequest = {
                    deploymentId: `erdtree-${Date.now()}`,
                    resourceType: selectedResource.name,
                    requestedBy: user?.username || user?.name || 'unknown@user.com',
                    environment: deploymentData.environment,
                    subscription: deploymentData.subscription,
                    tfvars: {
                        name: deploymentData.resourceName,
                        location: deploymentData.location,
                        resource_group_name: `erdtree-${deploymentData.environment}-rg`,
                        tags: {
                            deployedBy: 'Hermes',
                            managedBy: 'Terraform',
                            environment: deploymentData.environment,
                            application: 'erdtree-portal',
                            resourceType: selectedResource.id
                        }
                    }
                };
                
                try {
                    // Call Logic App webhook
                    const response = await fetch('https://prod-38.eastus.logic.azure.com:443/workflows/4e921619b68e49a1967c272a7aaa3c07/triggers/manual/paths/invoke?api-version=2019-05-01&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=pKeXaCOpZV57ct20BjZmPwtbYI8cnSfKXHqgIsHXiQU', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(deploymentRequest)
                    });
                    
                    if (response.ok) {
                        alert(`‚úÖ Deployment Request Submitted!\n\nDeployment ID: ${deploymentRequest.deploymentId}\nResource: ${selectedResource.name}\nEnvironment: ${deploymentData.environment}\n\nApproval email sent to: hemirafl@microsoft.com\n\nYou will be notified once approved and deployed.`);
                    } else {
                        throw new Error(`HTTP ${response.status}`);
                    }
                } catch (error) {
                    console.error('Deployment submission failed:', error);
                    alert(`‚ö†Ô∏è Deployment request logged locally.\n\nResource: ${selectedResource.name}\nEnvironment: ${deploymentData.environment}\n\nIn production, this would:\n1. Send to Logic App for approval\n2. Email hemirafl@microsoft.com\n3. Deploy via GitHub Actions\n4. Use Azure Verified Modules`);
                }
                
                setShowDeploymentForm(false);
                setSelectedResource(null);
            };
            
            // Loading state
            if (loading) {
                return (
                    <div className="min-h-screen flex items-center justify-center bg-gray-50">
                        <div className="text-center">
                            <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto mb-4"></div>
                            <p className="text-gray-600">Loading Erdtree Portal...</p>
                        </div>
                    </div>
                );
            }
            
            // Login screen
            if (!user) {
                return (
                    <div className="min-h-screen flex items-center justify-center bg-gradient-to-br from-blue-50 to-indigo-100">
                        <div className="max-w-md w-full mx-4">
                            <div className="bg-white rounded-lg shadow-xl p-8 text-center">
                                <div className="text-6xl mb-6">üå≥</div>
                                <h1 className="text-3xl font-bold text-gray-900 mb-4">
                                    Erdtree Self-Service Portal
                                </h1>
                                <p className="text-gray-600 mb-8">
                                    Deploy Azure infrastructure with automated approval workflows using Azure Verified Modules and Terraform.
                                </p>
                                <button
                                    onClick={handleLogin}
                                    disabled={loading}
                                    className="w-full bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700 transition-colors font-semibold disabled:opacity-50"
                                >
                                    {loading ? 'Signing in...' : 'üîê Sign in with Microsoft'}
                                </button>
                                <div className="mt-6 text-sm text-gray-500">
                                    <p>Secure authentication via Azure Active Directory</p>
                                </div>
                            </div>
                        </div>
                    </div>
                );
            }
            
            // Main portal interface
            return (
                <div className="min-h-screen bg-gray-50">
                    {/* Header */}
                    <header className="bg-white shadow-sm border-b border-gray-200">
                        <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                            <div className="flex justify-between items-center py-6">
                                <div className="flex items-center">
                                    <span className="text-3xl mr-3">üå≥</span>
                                    <div>
                                        <h1 className="text-2xl font-bold text-gray-900">
                                            Erdtree Self-Service Portal
                                        </h1>
                                        <p className="text-sm text-gray-600">Azure Infrastructure Deployment</p>
                                    </div>
                                </div>
                                <div className="flex items-center space-x-4">
                                    <div className="text-right">
                                        <p className="text-sm font-medium text-gray-900">
                                            {user.name || user.username}
                                        </p>
                                        <p className="text-xs text-gray-500">
                                            {user.username || user.homeAccountId}
                                        </p>
                                    </div>
                                    <button
                                        onClick={handleLogout}
                                        className="text-sm text-blue-600 hover:text-blue-800 font-medium"
                                    >
                                        Sign out
                                    </button>
                                </div>
                            </div>
                        </div>
                    </header>
                    
                    {/* Main Content */}
                    <main className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
                        <div className="mb-8">
                            <h2 className="text-3xl font-bold text-gray-900 mb-2">
                                Deploy Azure Infrastructure
                            </h2>
                            <p className="text-lg text-gray-600">
                                Select a resource type to deploy using Azure Verified Modules and Terraform
                            </p>
                        </div>
                        
                        {/* Resource Grid */}
                        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-12">
                            {resources.map(resource => (
                                <div
                                    key={resource.id}
                                    onClick={() => handleResourceSelect(resource)}
                                    className={`p-6 rounded-lg border-2 cursor-pointer transition-all transform hover:scale-105 ${getCategoryStyle(resource.color)}`}
                                >
                                    <div className="flex items-start space-x-4">
                                        <div className="text-4xl">{resource.icon}</div>
                                        <div className="flex-1">
                                            <h3 className="text-xl font-semibold text-gray-900 mb-2">
                                                {resource.name}
                                            </h3>
                                            <p className="text-sm text-gray-600 mb-3">
                                                {resource.desc}
                                            </p>
                                            <span className="inline-block px-2 py-1 text-xs font-medium bg-white rounded-full">
                                                {resource.category}
                                            </span>
                                        </div>
                                    </div>
                                </div>
                            ))}
                        </div>
                        
                        {/* System Status */}
                        <div className="bg-blue-50 border border-blue-200 rounded-lg p-6">
                            <h3 className="text-xl font-semibold text-blue-900 mb-4">
                                üöÄ System Status
                            </h3>
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                                <div className="space-y-2">
                                    <div className="flex items-center">
                                        <span className="text-green-500 mr-2">‚úÖ</span>
                                        <span>Azure CLI: Working</span>
                                    </div>
                                    <div className="flex items-center">
                                        <span className="text-green-500 mr-2">‚úÖ</span>
                                        <span>Azure AD: Authenticated</span>
                                    </div>
                                    <div className="flex items-center">
                                        <span className="text-green-500 mr-2">‚úÖ</span>
                                        <span>Web App: Deployed (Basic B1)</span>
                                    </div>
                                </div>
                                <div className="space-y-2">
                                    <div className="flex items-center">
                                        <span className="text-green-500 mr-2">‚úÖ</span>
                                        <span>Application Insights: Monitoring</span>
                                    </div>
                                    <div className="flex items-center">
                                        <span className="text-green-500 mr-2">‚úÖ</span>
                                        <span>Logic App: Approval workflow ready</span>
                                    </div>
                                    <div className="flex items-center">
                                        <span className="text-blue-500 mr-2">üîó</span>
                                        <span>GitHub: terraform-avm-cicd-demo</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </main>
                    
                    {/* Deployment Form Modal */}
                    {showDeploymentForm && selectedResource && (
                        <div className="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center z-50">
                            <div className="bg-white rounded-lg shadow-xl max-w-lg w-full mx-4 p-6">
                                <div className="flex items-center mb-4">
                                    <span className="text-3xl mr-3">{selectedResource.icon}</span>
                                    <h3 className="text-2xl font-semibold text-gray-900">
                                        Deploy {selectedResource.name}
                                    </h3>
                                </div>
                                
                                <p className="text-gray-600 mb-6">
                                    This deployment will use Azure Verified Modules and require approval from hemirafl@microsoft.com
                                </p>
                                
                                <div className="space-y-4">
                                    <div>
                                        <label className="block text-sm font-medium text-gray-700 mb-2">
                                            Resource Name
                                        </label>
                                        <input
                                            type="text"
                                            value={deploymentData.resourceName}
                                            onChange={(e) => setDeploymentData(prev => ({...prev, resourceName: e.target.value}))}
                                            className="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500"
                                            placeholder="Enter resource name"
                                        />
                                    </div>
                                    
                                    <div>
                                        <label className="block text-sm font-medium text-gray-700 mb-2">
                                            Environment
                                        </label>
                                        <select
                                            value={deploymentData.environment}
                                            onChange={(e) => setDeploymentData(prev => ({...prev, environment: e.target.value}))}
                                            className="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500"
                                        >
                                            <option value="dev">Development</option>
                                            <option value="prod">Production</option>
                                        </select>
                                    </div>
                                    
                                    <div>
                                        <label className="block text-sm font-medium text-gray-700 mb-2">
                                            Subscription
                                        </label>
                                        <select
                                            value={deploymentData.subscription}
                                            onChange={(e) => setDeploymentData(prev => ({...prev, subscription: e.target.value}))}
                                            className="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500"
                                        >
                                            <option value="Nokron-Prod">Nokron-Prod</option>
                                            <option value="FireGiants-Prod">FireGiants-Prod</option>
                                        </select>
                                    </div>
                                    
                                    <div>
                                        <label className="block text-sm font-medium text-gray-700 mb-2">
                                            Location
                                        </label>
                                        <select
                                            value={deploymentData.location}
                                            onChange={(e) => setDeploymentData(prev => ({...prev, location: e.target.value}))}
                                            className="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500"
                                        >
                                            <option value="West US 2">West US 2</option>
                                            <option value="East US">East US</option>
                                            <option value="Central US">Central US</option>
                                        </select>
                                    </div>
                                </div>
                                
                                <div className="flex space-x-4 mt-6">
                                    <button
                                        onClick={() => setShowDeploymentForm(false)}
                                        className="flex-1 px-4 py-2 border border-gray-300 rounded-md text-gray-700 hover:bg-gray-50 font-medium"
                                    >
                                        Cancel
                                    </button>
                                    <button
                                        onClick={handleDeploymentSubmit}
                                        className="flex-1 px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 font-medium"
                                    >
                                        Submit for Approval
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        }
        
        // Render the app
        ReactDOM.render(<ErdtreePortal />, document.getElementById('root'));
    </script>
    
    <!-- Babel for JSX transpiling -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</body>
</html>