<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>🌳 Erdtree Self-Service Portal</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://alcdn.msauth.net/browser/2.38.3/js/msal-browser.min.js"></script>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; }
        .resource-card { transition: all 0.3s ease; }
        .resource-card:hover { transform: translateY(-2px); box-shadow: 0 8px 25px rgba(0,0,0,0.15); }
        .loading-spinner { animation: spin 1s linear infinite; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <div id="root">
        <div class="min-h-screen flex items-center justify-center">
            <div class="text-center">
                <div class="loading-spinner rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto mb-4"></div>
                <p class="text-gray-600">Initializing Azure AD authentication...</p>
            </div>
        </div>
    </div>
    
    <script>
        // MSAL Configuration for Production Azure AD
        const msalConfig = {
            auth: {
                clientId: 'bddf94ca-ff1f-4cc9-aac9-4fd51d3af064',
                authority: 'https://login.microsoftonline.com/b6458a9a-9661-468c-bda3-5f496727d0b0',
                redirectUri: window.location.origin,
                postLogoutRedirectUri: window.location.origin
            },
            cache: {
                cacheLocation: 'sessionStorage',
                storeAuthStateInCookie: false,
            },
            system: {
                loggerOptions: {
                    loggerCallback: (level, message, containsPii) => {
                        if (containsPii) return;
                        if (level <= msal.LogLevel.Info) {
                            console.log('[MSAL]', message);
                        }
                    },
                    piiLoggingEnabled: false
                }
            }
        };

        // Login request configuration
        const loginRequest = {
            scopes: [
                'User.Read',
                'https://management.azure.com/user_impersonation'
            ],
            prompt: 'select_account'
        };

        // Silent request configuration  
        const silentRequest = {
            scopes: ['User.Read'],
            account: null
        };

        // Global variables
        let msalInstance = null;
        let currentUser = null;
        let selectedResource = null;
        let showDeploymentForm = false;
        let isLoading = true;
        let authError = null;
        
        let deploymentData = {
            environment: 'dev',
            subscription: 'Nokron-Prod',
            resourceName: '',
            location: 'West US 2'
        };
        
        // Resource definitions
        const resources = [
            { id: 'vm-windows', name: 'Windows VM', icon: '🖥️', desc: 'Deploy Windows Server virtual machines with IIS', category: 'compute', color: 'blue' },
            { id: 'vm-linux', name: 'Linux VM', icon: '🐧', desc: 'Deploy Ubuntu/RHEL virtual machines', category: 'compute', color: 'blue' },
            { id: 'storage', name: 'Storage Account', icon: '💾', desc: 'Create blob, file, and queue storage', category: 'storage', color: 'yellow' },
            { id: 'vnet', name: 'Virtual Network', icon: '🌐', desc: 'Create VNets with subnets and NSGs', category: 'network', color: 'green' },
            { id: 'webapp', name: 'Web App', icon: '🌍', desc: 'Host .NET/Node.js/Python applications', category: 'web', color: 'purple' },
            { id: 'loadbalancer', name: 'Load Balancer', icon: '⚖️', desc: 'Distribute traffic with high availability', category: 'network', color: 'green' }
        ];

        // Initialize MSAL and check for existing session
        async function initializeAuth() {
            try {
                console.log('Initializing MSAL...');
                msalInstance = new msal.PublicClientApplication(msalConfig);
                await msalInstance.initialize();
                
                console.log('MSAL initialized successfully');
                
                // Check if user is already logged in
                const accounts = msalInstance.getAllAccounts();
                if (accounts.length > 0) {
                    console.log('Found existing account:', accounts[0].username);
                    currentUser = accounts[0];
                    
                    // Try to get fresh token silently
                    try {
                        silentRequest.account = accounts[0];
                        const response = await msalInstance.acquireTokenSilent(silentRequest);
                        console.log('Silent token acquisition successful');
                        currentUser.accessToken = response.accessToken;
                    } catch (silentError) {
                        console.log('Silent token acquisition failed:', silentError);
                        // Continue with existing account info
                    }
                }
                
                isLoading = false;
                authError = null;
                render();
                
            } catch (error) {
                console.error('MSAL initialization failed:', error);
                authError = 'Authentication service unavailable. Please refresh the page.';
                isLoading = false;
                render();
            }
        }

        // Handle login
        async function handleLogin() {
            if (!msalInstance) {
                console.error('MSAL not initialized');
                return;
            }
            
            try {
                isLoading = true;
                render();
                
                console.log('Starting login process...');
                const response = await msalInstance.loginPopup(loginRequest);
                
                console.log('Login successful:', response.account.username);
                currentUser = response.account;
                currentUser.accessToken = response.accessToken;
                
                isLoading = false;
                authError = null;
                render();
                
            } catch (error) {
                console.error('Login failed:', error);
                isLoading = false;
                
                if (error.errorCode === 'user_cancelled') {
                    authError = 'Login was cancelled. Please try again.';
                } else if (error.errorCode === 'popup_window_error') {
                    authError = 'Popup blocked. Please allow popups and try again.';
                } else {
                    authError = 'Login failed. Please try again or contact support.';
                }
                
                render();
            }
        }

        // Handle logout
        async function handleLogout() {
            if (!msalInstance) return;
            
            try {
                console.log('Logging out...');
                await msalInstance.logoutPopup({
                    postLogoutRedirectUri: window.location.origin
                });
                
                currentUser = null;
                render();
                
            } catch (error) {
                console.error('Logout failed:', error);
                // Force logout on error
                currentUser = null;
                render();
            }
        }

        // Utility functions
        function getCategoryStyle(color) {
            const styles = {
                blue: 'bg-blue-50 border-blue-200 hover:bg-blue-100 hover:border-blue-300',
                green: 'bg-green-50 border-green-200 hover:bg-green-100 hover:border-green-300',
                yellow: 'bg-yellow-50 border-yellow-200 hover:bg-yellow-100 hover:border-yellow-300',
                purple: 'bg-purple-50 border-purple-200 hover:bg-purple-100 hover:border-purple-300'
            };
            return styles[color] || 'bg-gray-50 border-gray-200 hover:bg-gray-100';
        }

        // Resource selection
        function handleResourceSelect(resource) {
            selectedResource = resource;
            deploymentData.resourceName = `${resource.name.toLowerCase().replace(/\s+/g, '-')}-${Date.now()}`;
            showDeploymentForm = true;
            render();
        }

        // Deployment submission
        async function handleDeploymentSubmit() {
            const deploymentRequest = {
                deploymentId: `erdtree-${Date.now()}`,
                resourceType: selectedResource.name,
                requestedBy: currentUser?.username || currentUser?.name || 'unknown@user.com',
                environment: deploymentData.environment,
                subscription: deploymentData.subscription,
                tfvars: {
                    name: deploymentData.resourceName,
                    location: deploymentData.location,
                    resource_group_name: `erdtree-${deploymentData.environment}-rg`,
                    tags: {
                        deployedBy: 'Hermes',
                        managedBy: 'Terraform',
                        environment: deploymentData.environment,
                        application: 'erdtree-portal',
                        resourceType: selectedResource.id,
                        requestedBy: currentUser?.username || 'unknown'
                    }
                }
            };
            
            try {
                console.log('Submitting deployment request:', deploymentRequest);
                
                // Call Logic App
                const response = await fetch('https://prod-38.eastus.logic.azure.com:443/workflows/4e921619b68e49a1967c272a7aaa3c07/triggers/manual/paths/invoke?api-version=2019-05-01&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=pKeXaCOpZV57ct20BjZmPwtbYI8cnSfKXHqgIsHXiQU', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(deploymentRequest)
                });
                
                if (response.ok) {
                    const result = await response.json();
                    console.log('Logic App response:', result);
                    
                    alert(`✅ Deployment Request Submitted Successfully!\n\n` +
                          `Deployment ID: ${deploymentRequest.deploymentId}\n` +
                          `Resource: ${selectedResource.name}\n` +
                          `Environment: ${deploymentData.environment}\n` +
                          `Requested by: ${currentUser.username}\n\n` +
                          `✉️ Approval email sent to: hemirafl@microsoft.com\n\n` +
                          `You will receive a notification once the request is reviewed and processed.`);
                } else {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
            } catch (error) {
                console.error('Deployment submission failed:', error);
                
                alert(`⚠️ Deployment request logged (Logic App unavailable)\n\n` +
                      `Resource: ${selectedResource.name}\n` +
                      `Environment: ${deploymentData.environment}\n` +
                      `Requested by: ${currentUser.username}\n\n` +
                      `In production, this would:\n` +
                      `1. Send to Logic App for approval\n` +
                      `2. Email hemirafl@microsoft.com\n` +
                      `3. Deploy via GitHub Actions\n` +
                      `4. Use Azure Verified Modules\n\n` +
                      `Status: Request logged successfully!`);
            }
            
            showDeploymentForm = false;
            selectedResource = null;
            render();
        }

        // Render functions
        function renderLoadingScreen() {
            return `
                <div class="min-h-screen flex items-center justify-center bg-gray-50">
                    <div class="text-center">
                        <div class="loading-spinner rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto mb-4"></div>
                        <p class="text-gray-600">${isLoading ? 'Initializing Azure AD authentication...' : 'Loading portal...'}</p>
                    </div>
                </div>
            `;
        }

        function renderLoginScreen() {
            return `
                <div class="min-h-screen flex items-center justify-center bg-gradient-to-br from-blue-50 to-indigo-100">
                    <div class="max-w-md w-full mx-4">
                        <div class="bg-white rounded-lg shadow-xl p-8 text-center">
                            <div class="text-6xl mb-6">🌳</div>
                            <h1 class="text-3xl font-bold text-gray-900 mb-4">
                                Erdtree Self-Service Portal
                            </h1>
                            <p class="text-gray-600 mb-8">
                                Deploy Azure infrastructure with automated approval workflows using Azure Verified Modules and Terraform.
                            </p>
                            
                            ${authError ? `
                                <div class="mb-6 p-4 bg-red-50 border border-red-200 rounded-lg">
                                    <p class="text-red-700 text-sm">${authError}</p>
                                </div>
                            ` : ''}
                            
                            <button
                                onclick="handleLogin()"
                                disabled="${isLoading}"
                                class="w-full bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700 transition-colors font-semibold disabled:opacity-50 disabled:cursor-not-allowed"
                            >
                                ${isLoading ? 'Signing in...' : '🔐 Sign in with Microsoft'}
                            </button>
                            
                            <div class="mt-6 text-sm text-gray-500">
                                <p>✅ Azure Active Directory Authentication</p>
                                <p class="mt-1">🔒 Secure enterprise login</p>
                                <p class="mt-2 text-xs">Tenant: b6458a9a-9661-468c-bda3-5f496727d0b0</p>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderMainPortal() {
            return `
                <div class="min-h-screen bg-gray-50">
                    <!-- Header -->
                    <header class="bg-white shadow-sm border-b border-gray-200">
                        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                            <div class="flex justify-between items-center py-6">
                                <div class="flex items-center">
                                    <span class="text-3xl mr-3">🌳</span>
                                    <div>
                                        <h1 class="text-2xl font-bold text-gray-900">
                                            Erdtree Self-Service Portal
                                        </h1>
                                        <p class="text-sm text-gray-600">Azure Infrastructure Deployment</p>
                                    </div>
                                </div>
                                <div class="flex items-center space-x-4">
                                    <div class="text-right">
                                        <p class="text-sm font-medium text-gray-900">
                                            ${currentUser?.name || 'User'}
                                        </p>
                                        <p class="text-xs text-gray-500">
                                            ${currentUser?.username || currentUser?.homeAccountId || ''}
                                        </p>
                                        <p class="text-xs text-blue-600">
                                            ✅ Authenticated
                                        </p>
                                    </div>
                                    <button
                                        onclick="handleLogout()"
                                        class="text-sm text-blue-600 hover:text-blue-800 font-medium"
                                    >
                                        Sign out
                                    </button>
                                </div>
                            </div>
                        </div>
                    </header>
                    
                    <!-- Main Content -->
                    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
                        <div class="mb-8">
                            <h2 class="text-3xl font-bold text-gray-900 mb-2">
                                Deploy Azure Infrastructure
                            </h2>
                            <p class="text-lg text-gray-600">
                                Select a resource type to deploy using Azure Verified Modules and Terraform
                            </p>
                        </div>
                        
                        <!-- Resource Grid -->
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-12">
                            ${resources.map(resource => `
                                <div
                                    onclick="handleResourceSelect(${JSON.stringify(resource).replace(/"/g, '&quot;')})"
                                    class="resource-card p-6 rounded-lg border-2 cursor-pointer ${getCategoryStyle(resource.color)}"
                                >
                                    <div class="flex items-start space-x-4">
                                        <div class="text-4xl">${resource.icon}</div>
                                        <div class="flex-1">
                                            <h3 class="text-xl font-semibold text-gray-900 mb-2">
                                                ${resource.name}
                                            </h3>
                                            <p class="text-sm text-gray-600 mb-3">
                                                ${resource.desc}
                                            </p>
                                            <span class="inline-block px-2 py-1 text-xs font-medium bg-white rounded-full">
                                                ${resource.category}
                                            </span>
                                        </div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                        
                        <!-- System Status -->
                        <div class="bg-blue-50 border border-blue-200 rounded-lg p-6">
                            <h3 class="text-xl font-semibold text-blue-900 mb-4">
                                🚀 System Status
                            </h3>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                                <div class="space-y-2">
                                    <div class="flex items-center">
                                        <span class="text-green-500 mr-2">✅</span>
                                        <span>Azure AD: Authenticated (${currentUser?.username})</span>
                                    </div>
                                    <div class="flex items-center">
                                        <span class="text-green-500 mr-2">✅</span>
                                        <span>Portal: Online and functional</span>
                                    </div>
                                    <div class="flex items-center">
                                        <span class="text-green-500 mr-2">✅</span>
                                        <span>Web App: Deployed (Basic B1)</span>
                                    </div>
                                </div>
                                <div class="space-y-2">
                                    <div class="flex items-center">
                                        <span class="text-green-500 mr-2">✅</span>
                                        <span>Application Insights: Monitoring</span>
                                    </div>
                                    <div class="flex items-center">
                                        <span class="text-green-500 mr-2">✅</span>
                                        <span>Logic App: Approval workflow ready</span>
                                    </div>
                                    <div class="flex items-center">
                                        <span class="text-blue-500 mr-2">🔗</span>
                                        <span>GitHub: terraform-avm-cicd-demo</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </main>
                </div>
                
                ${showDeploymentForm ? renderDeploymentModal() : ''}
            `;
        }

        function renderDeploymentModal() {
            if (!selectedResource) return '';
            
            return `
                <div class="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center z-50">
                    <div class="bg-white rounded-lg shadow-xl max-w-lg w-full mx-4 p-6">
                        <div class="flex items-center mb-4">
                            <span class="text-3xl mr-3">${selectedResource.icon}</span>
                            <h3 class="text-2xl font-semibold text-gray-900">
                                Deploy ${selectedResource.name}
                            </h3>
                        </div>
                        
                        <p class="text-gray-600 mb-6">
                            This deployment will use Azure Verified Modules and require approval from hemirafl@microsoft.com
                        </p>
                        
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">
                                    Resource Name
                                </label>
                                <input
                                    type="text"
                                    id="resourceName"
                                    value="${deploymentData.resourceName}"
                                    onchange="deploymentData.resourceName = this.value"
                                    class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500"
                                    placeholder="Enter resource name"
                                />
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">
                                    Environment
                                </label>
                                <select
                                    id="environment"
                                    onchange="deploymentData.environment = this.value"
                                    class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500"
                                >
                                    <option value="dev" ${deploymentData.environment === 'dev' ? 'selected' : ''}>Development</option>
                                    <option value="prod" ${deploymentData.environment === 'prod' ? 'selected' : ''}>Production</option>
                                </select>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">
                                    Subscription
                                </label>
                                <select
                                    id="subscription"
                                    onchange="deploymentData.subscription = this.value"
                                    class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500"
                                >
                                    <option value="Nokron-Prod" ${deploymentData.subscription === 'Nokron-Prod' ? 'selected' : ''}>Nokron-Prod</option>
                                    <option value="FireGiants-Prod" ${deploymentData.subscription === 'FireGiants-Prod' ? 'selected' : ''}>FireGiants-Prod</option>
                                </select>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">
                                    Location
                                </label>
                                <select
                                    id="location"
                                    onchange="deploymentData.location = this.value"
                                    class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500"
                                >
                                    <option value="West US 2" ${deploymentData.location === 'West US 2' ? 'selected' : ''}>West US 2</option>
                                    <option value="East US" ${deploymentData.location === 'East US' ? 'selected' : ''}>East US</option>
                                    <option value="Central US" ${deploymentData.location === 'Central US' ? 'selected' : ''}>Central US</option>
                                </select>
                            </div>
                            
                            <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                                <p class="text-sm text-blue-800">
                                    <strong>Authenticated as:</strong> ${currentUser?.username}<br>
                                    <strong>Request will be sent to:</strong> hemirafl@microsoft.com
                                </p>
                            </div>
                        </div>
                        
                        <div class="flex space-x-4 mt-6">
                            <button
                                onclick="showDeploymentForm = false; render()"
                                class="flex-1 px-4 py-2 border border-gray-300 rounded-md text-gray-700 hover:bg-gray-50 font-medium"
                            >
                                Cancel
                            </button>
                            <button
                                onclick="handleDeploymentSubmit()"
                                class="flex-1 px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 font-medium"
                            >
                                Submit for Approval
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }

        // Main render function
        function render() {
            const root = document.getElementById('root');
            
            if (isLoading) {
                root.innerHTML = renderLoadingScreen();
            } else if (!currentUser) {
                root.innerHTML = renderLoginScreen();
            } else {
                root.innerHTML = renderMainPortal();
            }
        }

        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            console.log('🌳 Erdtree Portal - Starting with Azure AD authentication...');
            initializeAuth();
        });

        // Handle page visibility changes
        document.addEventListener('visibilitychange', function() {
            if (!document.hidden && msalInstance && currentUser) {
                // Page became visible, check if token needs refresh
                console.log('Page visible, checking token validity...');
            }
        });
    </script>
</body>
</html>